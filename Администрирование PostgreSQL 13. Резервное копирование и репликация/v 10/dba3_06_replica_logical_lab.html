<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=UTF8">
<style>
p.c    { }
h1     { font-size: 160%; font-weight: bold; padding-top: 1ex; padding-bottom: 1ex; }
div.s1 { margin-left: 20px; padding-left: 10px; font-weight: bold; }
div.s2 { margin-left: 80px; padding-left: 10px; font-weight: bold; }
div.s3 { margin-left: 140px; padding-left: 10px; font-weight: bold; }
div.r1 { margin-left: 20px; padding-left: 10px; }
div.r2 { margin-left: 80px; padding-left: 10px; }
div.r3 { margin-left: 140px; padding-left: 10px; }
div.e  { margin-left: 20px; padding-left: 10px; font-weight: bold; <!--color: darkblue;--> }
div.r  { margin-left: 20px; padding-left: 10px; <!--color: darkblue;--> }
</style>
</head>
<body>
<h1>
Базы данных и таблица
</h1>
<p class="C">
Сначала установим уровень журнала logical.
</p>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">student$ <span style="color:#00a150">psql</span> <span style="color:#323232">-</span>U postgres <span style="color:#323232">-</span>c <span style="color:#1094a0">&quot;ALTER SYSTEM SET wal_level = logical&quot;</span>
</pre>
</div>
<div class="R"><pre class="R">
ALTER SYSTEM
</pre></div>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">student$ <span style="color:#a00050">sudo</span> <span style="color:#00a150">pg_ctlcluster</span> <span style="color:#1094a0">10</span> alpha restart
</pre>
</div>
<p class="C">
Базы данных:
</p>
<div class="E">
<pre style="color:#323232; background-color:#ffffff; ">student$ <span style="color:#00a150">psql</span> 
</pre>
</div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  ">α<span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE DATABASE</span> replica_logical_1<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE DATABASE
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  ">α<span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE DATABASE</span> replica_logical_2<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE DATABASE
</pre></div>
<p class="C">
Таблица в первой базе:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  ">α<span style="color:#323232">=&gt;</span> <span style="color:#00a150">\c</span> replica_logical_1
</pre>
</div>
<div class="R1"><pre class="R1">
You are now connected to database &quot;replica_logical_1&quot; as user &quot;student&quot;.
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  ">α<span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE TABLE</span> <span style="color:#c73a69">test</span><span style="color:#323232">(</span>id <span style="color:#a00050">serial</span> <span style="color:#3b6ac8">PRIMARY KEY</span><span style="color:#323232">,</span> descr <span style="color:#a00050">text</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE TABLE
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  ">α<span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">INSERT INTO</span> <span style="color:#c73a69">test</span><span style="color:#323232">(</span>descr<span style="color:#323232">)</span> <span style="color:#3b6ac8">VALUES</span> <span style="color:#323232">(</span><span style="color:#1094a0">'Раз'</span><span style="color:#323232">), (</span><span style="color:#1094a0">'Два'</span><span style="color:#323232">), (</span><span style="color:#1094a0">'Три'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
INSERT 0 3
</pre></div>
<h1>
Перенос таблицы во вторую БД
</h1>
<p class="C">
Воспользоваться логической резервной копией особенно удобно, когда таблиц
много.
</p>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">student$ <span style="color:#00a150">pg_dump</span> <span style="color:#323232">--</span>schema-only replica_logical_1 | <span style="color:#00a150">psql</span> <span style="color:#323232">-</span>d replica_logical_2
</pre>
</div>
<div class="R"><pre class="R">
SET
SET
SET
SET
SET
 set_config 
------------
 
(1 row)

SET
SET
SET
CREATE EXTENSION
ERROR:  must be owner of extension plpgsql
SET
SET
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER TABLE
ALTER SEQUENCE
ALTER TABLE
ALTER TABLE
</pre></div>
<p class="C">
Переносить данные с помощью pg_dump не имеет смысла, поскольку в процессе
переноса таблицы могут измениться.
</p>
<div class="E">
<pre style="color:#323232; background-color:#ffffff; ">student$ <span style="color:#00a150">psql</span> <span style="color:#323232">-</span>d replica_logical_2
</pre>
</div>
<div class="S2">
<pre style="color:#323232; background-color:#ffffff;  ">α<span style="color:#323232">=&gt;</span> <span style="color:#00a150">\d</span> test<span style="color:#323232">;</span>
</pre>
</div>
<div class="R2"><pre class="R2">
                            Table &quot;public.test&quot;
 Column |  Type   | Collation | Nullable |             Default              
--------+---------+-----------+----------+----------------------------------
 id     | integer |           | not null | nextval('test_id_seq'::regclass)
 descr  | text    |           |          | 
Indexes:
    &quot;test_pkey&quot; PRIMARY KEY, btree (id)

</pre></div>
<h1>
Логическая репликация
</h1>
<p class="C">
Публикация:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  ">α<span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE PUBLICATION</span> test_pub <span style="color:#3b6ac8">FOR TABLE</span> test<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE PUBLICATION
</pre></div>
<p class="C">
Поскольку репликация будет настроена на одном и том же сервере, вначале
вручную создаем слот логической репликации.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  ">α<span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">pg_create_logical_replication_slot</span><span style="color:#323232">(</span><span style="color:#1094a0">'testslot'</span><span style="color:#323232">,</span><span style="color:#1094a0">'pgoutput'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
 pg_create_logical_replication_slot 
------------------------------------
 (testslot,0/1E05955C)
(1 row)

</pre></div>
<p class="C">
И затем создаем подписку:
</p>
<div class="S2">
<pre style="color:#323232; background-color:#ffffff;  ">α<span style="color:#323232">=&gt;</span> <span style="color:#00a150">\c</span> <span style="color:#323232">-</span> postgres
</pre>
</div>
<div class="R2"><pre class="R2">
You are now connected to database &quot;replica_logical_2&quot; as user &quot;postgres&quot;.
</pre></div>
<div class="S2">
<pre style="color:#323232; background-color:#ffffff;  ">α<span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE SUBSCRIPTION</span> test_sub
<span style="color:#3b6ac8">CONNECTION</span> <span style="color:#1094a0">'user=student dbname=replica_logical_1'</span>
<span style="color:#3b6ac8">PUBLICATION</span> test_pub
<span style="color:#3b6ac8">WITH</span> <span style="color:#323232">(</span>create_slot <span style="color:#323232">=</span> <span style="color:#3b6ac8">false</span><span style="color:#323232">,</span> slot_name <span style="color:#323232">=</span> testslot<span style="color:#323232">);</span>

</pre>
</div>
<div class="R2"><pre class="R2">
CREATE SUBSCRIPTION
</pre></div>
<h1>
Проверка
</h1>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  ">α<span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">INSERT INTO</span> <span style="color:#c73a69">test</span><span style="color:#323232">(</span>descr<span style="color:#323232">)</span> <span style="color:#3b6ac8">VALUES</span> <span style="color:#323232">(</span><span style="color:#1094a0">'Четыре'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
INSERT 0 1
</pre></div>
<div class="S2">
<pre style="color:#323232; background-color:#ffffff;  ">α<span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#323232">*</span> <span style="color:#3b6ac8">FROM</span> test<span style="color:#323232">;</span>
</pre>
</div>
<div class="R2"><pre class="R2">
 id | descr  
----+--------
  1 | &#1056;&#1072;&#1079;
  2 | &#1044;&#1074;&#1072;
  3 | &#1058;&#1088;&#1080;
  4 | &#1063;&#1077;&#1090;&#1099;&#1088;&#1077;
(4 rows)

</pre></div>
<h1>
Удаление подписки
</h1>
<div class="S2">
<pre style="color:#323232; background-color:#ffffff;  ">α<span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">DROP SUBSCRIPTION</span> test_sub<span style="color:#323232">;</span>
</pre>
</div>
<div class="R2"><pre class="R2">
NOTICE:  dropped replication slot &quot;testslot&quot; on publisher
DROP SUBSCRIPTION
</pre></div>
</body>
</html>
