<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=UTF8">
<style>
p.c    { }
h1     { font-size: 160%; font-weight: bold; padding-top: 1ex; padding-bottom: 1ex; }
div.s1 { margin-left: 20px; padding-left: 10px; font-weight: bold; }
div.s2 { margin-left: 80px; padding-left: 10px; font-weight: bold; }
div.s3 { margin-left: 140px; padding-left: 10px; font-weight: bold; }
div.r1 { margin-left: 20px; padding-left: 10px; }
div.r2 { margin-left: 80px; padding-left: 10px; }
div.r3 { margin-left: 140px; padding-left: 10px; }
div.e  { margin-left: 20px; padding-left: 10px; font-weight: bold; <!--color: darkblue;--> }
div.r  { margin-left: 20px; padding-left: 10px; <!--color: darkblue;--> }
</style>
</head>
<body>
<h1>
База данных и таблица
</h1>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  ">α<span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE DATABASE</span> backup_archive<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE DATABASE
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  ">α<span style="color:#323232">=&gt;</span> <span style="color:#00a150">\c</span> backup_archive
</pre>
</div>
<div class="R1"><pre class="R1">
You are now connected to database &quot;backup_archive&quot; as user &quot;student&quot;.
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  ">α<span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE TABLE</span> <span style="color:#c73a69">t</span><span style="color:#323232">(</span>s <span style="color:#a00050">text</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE TABLE
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  ">α<span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">INSERT INTO</span> t <span style="color:#3b6ac8">VALUES</span> <span style="color:#323232">(</span><span style="color:#1094a0">'Привет, мир!'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
INSERT 0 1
</pre></div>
<h1>
Настройка непрерывной архивации
</h1>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">postgres$ <span style="color:#3b6ac8">mkdir</span> <span style="color:#323232">/</span>var<span style="color:#323232">/</span>lib<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span>archive
</pre>
<pre style="color:#323232; background-color:#ffffff;  ">student$ <span style="color:#00a150">psql</span> <span style="color:#323232">-</span>U postgres <span style="color:#323232">-</span>c <span style="color:#1094a0">&quot;ALTER SYSTEM SET archive_mode = on&quot;</span>
</pre>
</div>
<div class="R"><pre class="R">
ALTER SYSTEM
</pre></div>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">student$ <span style="color:#00a150">psql</span> <span style="color:#323232">-</span>U postgres <span style="color:#323232">-</span>c <span style="color:#1094a0">&quot;ALTER SYSTEM SET archive_command = 'test ! -f /var/lib/postgresql/archive/%f &amp;&amp; cp %p /var/lib/postgresql/archive/%f'&quot;</span>
</pre>
</div>
<div class="R"><pre class="R">
ALTER SYSTEM
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  ">α<span style="color:#323232">=&gt;</span> <span style="color:#00a150">\q</span>
</pre>
</div>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">student$ <span style="color:#a00050">sudo</span> <span style="color:#00a150">pg_ctlcluster</span> <span style="color:#1094a0">10</span> alpha restart
</pre>
</div>
<h1>
Базовая резервная копия
</h1>
<p class="C">
Поскольку нам потребуется восстанавливаться из одной копии два раза, сделаем
ее в формате tar.
</p>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">postgres$ <span style="color:#3b6ac8">mkdir</span> <span style="color:#323232">/</span>var<span style="color:#323232">/</span>lib<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span>backup
</pre>
<pre style="color:#323232; background-color:#ffffff;  ">postgres$ <span style="color:#00a150">pg_basebackup</span> <span style="color:#323232">-</span>U student <span style="color:#323232">--</span>wal-method<span style="color:#323232">=</span>none <span style="color:#323232">--</span>format<span style="color:#323232">=</span><span style="color:#3b6ac8">tar</span> <span style="color:#323232">--</span>pgdata<span style="color:#323232">=/</span>var<span style="color:#323232">/</span>lib<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span>backup
</pre>
</div>
<div class="R"><pre class="R">
NOTICE:  pg_stop_backup complete, all required WAL segments have been archived
</pre></div>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">postgres$ <span style="color:#3b6ac8">ls</span> <span style="color:#323232">-</span>l <span style="color:#323232">/</span>var<span style="color:#323232">/</span>lib<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span>backup
</pre>
</div>
<div class="R"><pre class="R">
total 37472
-rw-r--r-- 1 postgres postgres 38368768 &#1080;&#1102;&#1085; 13 20:00 base.tar
</pre></div>
<h1>
Добавление строк в таблицу
</h1>
<div class="E">
<pre style="color:#323232; background-color:#ffffff; ">student$ <span style="color:#00a150">psql</span> <span style="color:#323232">-</span>d backup_archive
</pre>
</div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  ">α<span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">INSERT INTO</span> t <span style="color:#3b6ac8">VALUES</span> <span style="color:#323232">(</span><span style="color:#1094a0">'Еще одна строка'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
INSERT 0 1
</pre></div>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">student$ <span style="color:#00a150">psql</span> <span style="color:#323232">-</span>U postgres <span style="color:#323232">-</span>c <span style="color:#1094a0">&quot;SELECT pg_switch_wal()&quot;</span>
</pre>
</div>
<div class="R"><pre class="R">
 pg_switch_wal 
---------------
 0/15002680
(1 row)
</pre></div>
<p class="C">
Чтобы произошло реальное переключение, надо, чтобы в журнал попала следующая
(любая) запись:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  ">α<span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">pg_walfile_name</span><span style="color:#323232">(</span><span style="color:#c73a69">pg_current_wal_lsn</span><span style="color:#323232">());</span>
</pre>
</div>
<div class="R1"><pre class="R1">
     pg_walfile_name      
--------------------------
 000000020000000000000015
(1 row)

</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  ">α<span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">VACUUM</span> t<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
VACUUM
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  ">α<span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">pg_walfile_name</span><span style="color:#323232">(</span><span style="color:#c73a69">pg_current_wal_lsn</span><span style="color:#323232">());</span>
</pre>
</div>
<div class="R1"><pre class="R1">
     pg_walfile_name      
--------------------------
 000000020000000000000016
(1 row)

</pre></div>
<h1>
Восстановление из базовой резервной копии
</h1>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">postgres$ <span style="color:#3b6ac8">rm</span> <span style="color:#323232">-</span>rf <span style="color:#323232">/</span>var<span style="color:#323232">/</span>lib<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span><span style="color:#1094a0">10</span><span style="color:#323232">/</span>beta<span style="color:#323232">/*</span>
</pre>
<pre style="color:#323232; background-color:#ffffff;  ">postgres$ <span style="color:#3b6ac8">tar</span> <span style="color:#323232">-</span>xf <span style="color:#323232">/</span>var<span style="color:#323232">/</span>lib<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span>backup<span style="color:#323232">/</span>base.<span style="color:#3b6ac8">tar</span> <span style="color:#323232">-</span>C <span style="color:#323232">/</span>var<span style="color:#323232">/</span>lib<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span><span style="color:#1094a0">10</span><span style="color:#323232">/</span>beta
</pre>
</div>
<p class="C">
Порт:
</p>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">postgres$ <span style="color:#3b6ac8">echo</span> <span style="color:#1094a0">'port = 5433'</span> <span style="color:#323232">&gt;&gt; /</span>var<span style="color:#323232">/</span>lib<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span><span style="color:#1094a0">10</span><span style="color:#323232">/</span>beta<span style="color:#323232">/</span>postgresql.auto.conf
</pre>
</div>
<p class="C">
Для простоты отключим непрерывное архивирование на резервном сервере.
</p>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">postgres$ <span style="color:#3b6ac8">sed</span> <span style="color:#323232">-</span>i <span style="color:#1094a0">&quot;s/archive_mode = 'on'/archive_mode = 'off'/&quot;</span> <span style="color:#323232">/</span>var<span style="color:#323232">/</span>lib<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span><span style="color:#1094a0">10</span><span style="color:#323232">/</span>beta<span style="color:#323232">/</span>postgresql.auto.conf
</pre>
</div>
<p class="C">
В файл recovery.conf записываем только команду восстановления:
</p>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">postgres$ <span style="color:#3b6ac8">echo</span> <span style="color:#1094a0">&quot;restore_command = 'cp /var/lib/postgresql/archive/%f %p'&quot;</span> <span style="color:#323232">&gt;/</span>var<span style="color:#323232">/</span>lib<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span><span style="color:#1094a0">10</span><span style="color:#323232">/</span>beta<span style="color:#323232">/</span>recovery.conf
</pre>
<pre style="color:#323232; background-color:#ffffff;  ">student$ <span style="color:#a00050">sudo</span> <span style="color:#00a150">pg_ctlcluster</span> <span style="color:#1094a0">10</span> beta start
</pre>
<pre style="color:#323232; background-color:#ffffff; ">student$ <span style="color:#00a150">psql</span> <span style="color:#323232">-</span>p <span style="color:#1094a0">5433</span> <span style="color:#323232">-</span>d backup_archive
</pre>
</div>
<div class="S2">
<pre style="color:#323232; background-color:#ffffff;  ">β<span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#323232">*</span> <span style="color:#3b6ac8">FROM</span> t<span style="color:#323232">;</span>
</pre>
</div>
<div class="R2"><pre class="R2">
        s        
-----------------
 &#1055;&#1088;&#1080;&#1074;&#1077;&#1090;, &#1084;&#1080;&#1088;!
 &#1045;&#1097;&#1077; &#1086;&#1076;&#1085;&#1072; &#1089;&#1090;&#1088;&#1086;&#1082;&#1072;
(2 rows)

</pre></div>
<p class="C">
Восстановились все строки.
</p>
<h1>
Восстановление из базовой резервной копии - immediate
</h1>
<div class="S2">
<pre style="color:#323232; background-color:#ffffff;  ">β<span style="color:#323232">=&gt;</span> <span style="color:#00a150">\q</span>
</pre>
</div>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">student$ <span style="color:#a00050">sudo</span> <span style="color:#00a150">pg_ctlcluster</span> <span style="color:#1094a0">10</span> beta stop
</pre>
<pre style="color:#323232; background-color:#ffffff;  ">postgres$ <span style="color:#3b6ac8">rm</span> <span style="color:#323232">-</span>rf <span style="color:#323232">/</span>var<span style="color:#323232">/</span>lib<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span><span style="color:#1094a0">10</span><span style="color:#323232">/</span>beta<span style="color:#323232">/*</span>
</pre>
<pre style="color:#323232; background-color:#ffffff;  ">postgres$ <span style="color:#3b6ac8">tar</span> <span style="color:#323232">-</span>xf <span style="color:#323232">/</span>var<span style="color:#323232">/</span>lib<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span>backup<span style="color:#323232">/</span>base.<span style="color:#3b6ac8">tar</span> <span style="color:#323232">-</span>C <span style="color:#323232">/</span>var<span style="color:#323232">/</span>lib<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span><span style="color:#1094a0">10</span><span style="color:#323232">/</span>beta
</pre>
<pre style="color:#323232; background-color:#ffffff;  ">postgres$ <span style="color:#3b6ac8">echo</span> <span style="color:#1094a0">'port = 5433'</span> <span style="color:#323232">&gt;&gt; /</span>var<span style="color:#323232">/</span>lib<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span><span style="color:#1094a0">10</span><span style="color:#323232">/</span>beta<span style="color:#323232">/</span>postgresql.auto.conf
</pre>
<pre style="color:#323232; background-color:#ffffff;  ">postgres$ <span style="color:#3b6ac8">sed</span> <span style="color:#323232">-</span>i <span style="color:#1094a0">&quot;s/archive_mode = 'on'/archive_mode = 'off'/&quot;</span> <span style="color:#323232">/</span>var<span style="color:#323232">/</span>lib<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span><span style="color:#1094a0">10</span><span style="color:#323232">/</span>beta<span style="color:#323232">/</span>postgresql.auto.conf
</pre>
</div>
<p class="C">
В файл recovery.conf записываем команду восстановления и целевую точку:
</p>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">postgres$ <span style="color:#3b6ac8">echo</span> <span style="color:#1094a0">&quot;restore_command = 'cp /var/lib/postgresql/archive/%f %p'&quot;</span> <span style="color:#323232">&gt;/</span>var<span style="color:#323232">/</span>lib<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span><span style="color:#1094a0">10</span><span style="color:#323232">/</span>beta<span style="color:#323232">/</span>recovery.conf
</pre>
<pre style="color:#323232; background-color:#ffffff;  ">postgres$ <span style="color:#3b6ac8">echo</span> <span style="color:#1094a0">&quot;recovery_target = 'immediate'&quot;</span> <span style="color:#323232">&gt;&gt;/</span>var<span style="color:#323232">/</span>lib<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span><span style="color:#1094a0">10</span><span style="color:#323232">/</span>beta<span style="color:#323232">/</span>recovery.conf
</pre>
<pre style="color:#323232; background-color:#ffffff;  ">student$ <span style="color:#a00050">sudo</span> <span style="color:#00a150">pg_ctlcluster</span> <span style="color:#1094a0">10</span> beta start
</pre>
<pre style="color:#323232; background-color:#ffffff; ">student$ <span style="color:#00a150">psql</span> <span style="color:#323232">-</span>p <span style="color:#1094a0">5433</span> <span style="color:#323232">-</span>d backup_archive
</pre>
</div>
<div class="S2">
<pre style="color:#323232; background-color:#ffffff;  ">β<span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#323232">*</span> <span style="color:#3b6ac8">FROM</span> t<span style="color:#323232">;</span>
</pre>
</div>
<div class="R2"><pre class="R2">
      s       
--------------
 &#1055;&#1088;&#1080;&#1074;&#1077;&#1090;, &#1084;&#1080;&#1088;!
(1 row)

</pre></div>
<p class="C">
Восстановилась только первая строка.
</p>
</body>
</html>
