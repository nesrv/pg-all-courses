<html><head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF8">
  <style>
  p.C    { font-size: 80%; }
  li     { font-size: 80%; }
  h1     { font-size: 100%; font-weight: bold; padding-top: 1ex; padding-bottom: 1ex; }
  div.S1 { padding-left: 0px; font-weight: bold; page-break-inside: avoid; }
  div.S2 { padding-left: 20px; font-weight: bold; page-break-inside: avoid; border-left: 1px solid grey; }
  div.S3 { padding-left: 40px; font-weight: bold; page-break-inside: avoid; border-left: 3px double grey; }
  div.R1 { padding-left: 0px; page-break-inside: avoid; }
  div.R2 { padding-left: 20px; page-break-inside: avoid; border-left: 1px solid grey; }
  div.R3 { padding-left: 40px; page-break-inside: avoid; border-left: 3px double grey; }
  div.E  { padding-left: 0px; font-weight: bold; }
  div.R  { padding-left: 0px; }
  </style>
  </head>
  <body style="margin: 59.5px;">
  <!-- body -->
  <!--  -->
  <h1>
  1. Использование кеша для обычных и временных таблиц
  </h1>
  <div class="S1">
  <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE DATABASE</span> arch_wal_overview<span style="color:#323232">;</span>
  </pre>
  </div>
  <div class="R1"><pre class="R1">CREATE DATABASE
  </pre></div>
  <div class="S1">
  <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\c</span> arch_wal_overview
  </pre>
  </div>
  <div class="R1"><pre class="R1">You are now connected to database "arch_wal_overview" as user "student".
  </pre></div>
  <p class="C">
  Создадим обычную таблицу с одной строкой...
  </p>
  <div class="S1">
  <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE TABLE</span> <span style="color:#c73a69">t</span><span style="color:#323232">(</span>n <span style="color:#a00050">integer</span><span style="color:#323232">);</span>
  </pre>
  </div>
  <div class="R1"><pre class="R1">CREATE TABLE
  </pre></div>
  <div class="S1">
  <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">INSERT INTO</span> <span style="color:#c73a69">t</span><span style="color:#323232">(</span>n<span style="color:#323232">)</span> <span style="color:#3b6ac8">VALUES</span> <span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">);</span>
  </pre>
  </div>
  <div class="R1"><pre class="R1">INSERT 0 1
  </pre></div>
  <p class="C">
  ...и такую же временную таблицу.
  </p>
  <div class="S1">
  <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE TEMPORARY TABLE</span> <span style="color:#c73a69">tt</span><span style="color:#323232">(</span>n <span style="color:#a00050">integer</span><span style="color:#323232">);</span>
  </pre>
  </div>
  <div class="R1"><pre class="R1">CREATE TABLE
  </pre></div>
  <div class="S1">
  <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">INSERT INTO</span> <span style="color:#c73a69">tt</span><span style="color:#323232">(</span>n<span style="color:#323232">)</span> <span style="color:#3b6ac8">VALUES</span> <span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">);</span>
  </pre>
  </div>
  <div class="R1"><pre class="R1">INSERT 0 1
  </pre></div>
  <p class="C">
  Обновление строки в обычной таблице:
  </p>
  <div class="S1">
  <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">EXPLAIN</span> <span style="color:#323232">(</span>analyze<span style="color:#323232">,</span> buffers<span style="color:#323232">,</span> costs off<span style="color:#323232">,</span> timing off<span style="color:#323232">)</span>
  <span style="color:#3b6ac8">UPDATE</span> t <span style="color:#3b6ac8">SET</span> n <span style="color:#323232">=</span> n <span style="color:#323232">+</span> <span style="color:#1094a0">1</span><span style="color:#323232">;</span>
  </pre>
  </div>
  <div class="R1"><pre class="R1">                 QUERY PLAN                  
  ---------------------------------------------
   Update on t (actual rows=0 loops=1)
     Buffers: shared hit=2
     -&gt;  Seq Scan on t (actual rows=1 loops=1)
           Buffers: shared hit=1
   Planning Time: 0.114 ms
   Execution Time: 0.055 ms
  (6 rows)
  
  </pre></div>
  <ul class="U">
  <li>
  При сканировании таблицы (Seq Scan) страница была найдена в буферном кеше (shared hit=1).
  </li>
  <li>
  При обновлении потребовалось прочитать две страницы (shared hit=2). Вторая страница относится к карте видимости (с которой мы познакомимся в модуле «Организация данных»).
  </li>
  </ul>
  <p class="C">
  Обновление строки во временной таблице:
  </p>
  <div class="S1">
  <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">EXPLAIN</span> <span style="color:#323232">(</span>analyze<span style="color:#323232">,</span> buffers<span style="color:#323232">,</span> costs off<span style="color:#323232">,</span> timing off<span style="color:#323232">)</span>
  <span style="color:#3b6ac8">UPDATE</span> tt <span style="color:#3b6ac8">SET</span> n <span style="color:#323232">=</span> n <span style="color:#323232">+</span> <span style="color:#1094a0">1</span><span style="color:#323232">;</span>
  </pre>
  </div>
  <div class="R1"><pre class="R1">                  QUERY PLAN                  
  ----------------------------------------------
   Update on tt (actual rows=0 loops=1)
     Buffers: local hit=2
     -&gt;  Seq Scan on tt (actual rows=1 loops=1)
           Buffers: local hit=1
   Planning Time: 0.047 ms
   Execution Time: 0.033 ms
  (6 rows)
  
  </pre></div>
  <p class="C">
  Отличие в том, что вместо общего буферного кеша, расположенного в разделяемой памяти сервера, используется локальный кеш текущего сеанса (local).
  </p>
  <h1>
  2. Нежурналируемые таблицы при сбое
  </h1>
  <p class="C">
  Создаем нежурналируемую таблицу:
  </p>
  <div class="S1">
  <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE UNLOGGED TABLE</span> <span style="color:#c73a69">u</span><span style="color:#323232">(</span>s <span style="color:#a00050">text</span><span style="color:#323232">);</span>
  </pre>
  </div>
  <div class="R1"><pre class="R1">CREATE TABLE
  </pre></div>
  <div class="S1">
  <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">INSERT INTO</span> u <span style="color:#3b6ac8">VALUES</span> <span style="color:#323232">(</span><span style="color:#1094a0">'Привет!'</span><span style="color:#323232">);</span>
  </pre>
  </div>
  <div class="R1"><pre class="R1">INSERT 0 1
  </pre></div>
  <p class="C">
  Имитируем сбой:
  </p>
  <div class="E">
  <pre style="color:#323232; background-color:#ffffff;  ">student$ <span style="color:#a00050">sudo</span> <span style="color:#00a150">pg_ctlcluster</span> <span style="color:#1094a0">12</span> main stop <span style="color:#323232">-</span>m immediate <span style="color:#323232">--</span>skip-systemctl-redirect
  </pre>
  </div>
  <p class="C">
  Запускаем сервер:
  </p>
  <div class="E">
  <pre style="color:#323232; background-color:#ffffff;  ">student$ <span style="color:#a00050">sudo</span> <span style="color:#00a150">pg_ctlcluster</span> <span style="color:#1094a0">12</span> main start
  </pre>
  <pre style="color:#323232; background-color:#ffffff;  ">student$ <span style="color:#00a150">psql</span> arch_wal_overview
  </pre>
  </div>
  <div class="S1">
  <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#323232">*</span> <span style="color:#3b6ac8">FROM</span> u<span style="color:#323232">;</span>
  </pre>
  </div>
  <div class="R1"><pre class="R1"> s 
  ---
  (0 rows)
  
  </pre></div>
  <p class="C">
  Таблица на месте, но она пуста. Содержимое нежурналируемых таблиц не восстанавливается при сбое; вместо этого такие таблицы «обнуляются».
  </p>
  <p class="C">
  Проверим журнал сообщений:
  </p>
  <div class="E">
  <pre style="color:#323232; background-color:#ffffff;  ">student$ <span style="color:#3b6ac8">tail</span> <span style="color:#323232">-</span>n <span style="color:#1094a0">5</span> <span style="color:#323232">/</span>var<span style="color:#323232">/</span>log<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span>postgresql-12-main.log
  </pre>
  </div>
  <div class="R"><pre class="R">2023-07-26 11:10:40.801 MSK [34986] LOG:  database system was not properly shut down; automatic recovery in progress
  2023-07-26 11:10:40.824 MSK [34986] LOG:  redo starts at 0/3B216F40
  2023-07-26 11:10:40.828 MSK [34986] LOG:  invalid record length at 0/3B2363C8: wanted 24, got 0
  2023-07-26 11:10:40.828 MSK [34986] LOG:  redo done at 0/3B235F48
  2023-07-26 11:10:41.192 MSK [34985] LOG:  database system is ready to accept connections
  </pre></div>
  <p class="C">
  Здесь мы видим, что при запуске был установлен факт аварийного завершения и было произведено автоматическое восстановление.
  </p>
  <!-- end -->
  
  
  </body></html>
  