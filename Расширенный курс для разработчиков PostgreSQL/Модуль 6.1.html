<html><head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF8">
    <style>
    p.C    { font-size: 80%; }
    li     { font-size: 80%; }
    h1     { font-size: 100%; font-weight: bold; padding-top: 1ex; padding-bottom: 1ex; }
    div.S1 { padding-left: 0px; font-weight: bold; page-break-inside: avoid; }
    div.S2 { padding-left: 20px; font-weight: bold; page-break-inside: avoid; border-left: 1px solid grey; }
    div.S3 { padding-left: 40px; font-weight: bold; page-break-inside: avoid; border-left: 3px double grey; }
    div.R1 { padding-left: 0px; page-break-inside: avoid; }
    div.R2 { padding-left: 20px; page-break-inside: avoid; border-left: 1px solid grey; }
    div.R3 { padding-left: 40px; page-break-inside: avoid; border-left: 3px double grey; }
    div.E  { padding-left: 0px; font-weight: bold; }
    div.R  { padding-left: 0px; }
    </style>
    </head>
    <body style="margin: 59.5px;">
    <!-- body -->
    <!-- 5 -->
    <h1>
    Функции без параметров
    </h1>
    <p class="C">
    Вот простой пример функции без параметров:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">hello_world</span><span style="color:#323232">()</span> <span style="color:#969696">-- имя и пустой список параметров</span>
    <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">text</span>                     <span style="color:#969696">-- тип возвращаемого значения</span>
    <span style="color:#3b6ac8">AS</span> $$ <span style="color:#3b6ac8">SELECT</span> <span style="color:#1094a0">'Hello, world!'</span><span style="color:#323232">;</span> $$ <span style="color:#969696">-- тело</span>
    <span style="color:#3b6ac8">LANGUAGE</span> sql<span style="color:#323232">;</span>                    <span style="color:#969696">-- указание языка</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">CREATE FUNCTION
    </pre></div>
    <p class="C">
    Тело удобно записывать в строке, заключенной в кавычки-доллары, как в приведенном примере. Иначе придется заботиться об экранировании кавычек, которые наверняка встретятся в теле функции. Сравните:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#1094a0">' SELECT '</span><span style="color:#1094a0">'Hello, world!'</span><span style="color:#1094a0">'; '</span><span style="color:#323232">;</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">         ?column?          
    ---------------------------
      SELECT 'Hello, world!'; 
    (1 row)
    
    </pre></div>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> $$ <span style="color:#3b6ac8">SELECT</span> <span style="color:#1094a0">'Hello, world!'</span><span style="color:#323232">;</span> $$<span style="color:#323232">;</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">         ?column?          
    ---------------------------
      SELECT 'Hello, world!'; 
    (1 row)
    
    </pre></div>
    <p class="C">
    При необходимости кавычки-доллары могут быть вложенными. Для этого в каждой паре кавычек надо использовать разный текст между долларами:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> $func$ <span style="color:#3b6ac8">SELECT</span> $$Hello<span style="color:#323232">,</span> world<span style="color:#323232">!</span>$$<span style="color:#323232">;</span> $func$<span style="color:#323232">;</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">          ?column?           
    -----------------------------
      SELECT $$Hello, world!$$; 
    (1 row)
    
    </pre></div>
    <p class="C">
    Функция вызывается в контексте выражения, например:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">hello_world</span><span style="color:#323232">();</span> <span style="color:#969696">-- пустые скобки обязательны</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">  hello_world  
    ---------------
     Hello, world!
    (1 row)
    
    </pre></div>
    <p class="C">
    В общем случае тело функции может состоять из нескольких операторов SQL. В качестве значения функции возвращается значение из первой строки, которую вернул последний оператор.
    </p>
    <p class="C">
    Не все операторы SQL можно использовать в функции. Запрещены:
    </p>
    <ul class="U">
    <li>
    команды управления транзакциями (BEGIN, COMMIT, ROLLBACK и т. п.);
    </li>
    <li>
    служебные команды (такие как VACUUM или CREATE INDEX).
    </li>
    </ul>
    <p class="C">
    Вот пример неправильной функции. Здесь мы использовали псевдотип void, который говорит о том, что функция не возвращает ничего.
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">do_commit</span><span style="color:#323232">()</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">void</span> <span style="color:#3b6ac8">AS</span> $$
    <span style="color:#3b6ac8">COMMIT</span><span style="color:#323232">;</span>
    $$ <span style="color:#3b6ac8">LANGUAGE</span> sql<span style="color:#323232">;</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">CREATE FUNCTION
    </pre></div>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">do_commit</span><span style="color:#323232">();</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">ERROR:  COMMIT is not allowed in a SQL function
    CONTEXT:  SQL function "do_commit" during startup
    </pre></div>
    <p class="C">
    Управлять транзакциями можно в процедурах, о чем мы будем говорить в следующей теме.
    </p>
    <hr size="0" style="border-top: 1px dashed grey; border-bottom: 0;">
    <h1>
    Функции с входными параметрами
    </h1>
    <p class="C">
    Пример функции с одним параметром:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span>name <span style="color:#a00050">text</span><span style="color:#323232">)</span> <span style="color:#969696">-- формальный параметр</span>
    <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">text</span> <span style="color:#3b6ac8">AS</span> $$
    <span style="color:#3b6ac8">SELECT</span> <span style="color:#1094a0">'Hello, '</span> || name || <span style="color:#1094a0">'!'</span><span style="color:#323232">;</span>
    $$ <span style="color:#3b6ac8">LANGUAGE</span> sql<span style="color:#323232">;</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">CREATE FUNCTION
    </pre></div>
    <p class="C">
    При вызове функции мы указываем фактический параметр, соответствующий формальному:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span><span style="color:#1094a0">'Alice'</span><span style="color:#323232">);</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">     hello     
    ---------------
     Hello, Alice!
    (1 row)
    
    </pre></div>
    <p class="C">
    При указании типа параметра можно указать и модификатор (например, varchar(10)), но он игнорируется.
    </p>
    <p class="C">
    Можно определить параметр функции без имени; тогда внутри тела функции на параметры придется ссылаться по номеру. Удалим функцию и создадим новую:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">DROP FUNCTION</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span><span style="color:#a00050">text</span><span style="color:#323232">);</span> <span style="color:#969696">-- достаточно указать тип параметра</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">DROP FUNCTION
    </pre></div>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span><span style="color:#a00050">text</span><span style="color:#323232">)</span>
    <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">text</span> <span style="color:#3b6ac8">AS</span> $$
    <span style="color:#3b6ac8">SELECT</span> <span style="color:#1094a0">'Hello, '</span> || <span style="color:#00a150">$1</span> || <span style="color:#1094a0">'!'</span><span style="color:#323232">;</span> <span style="color:#969696">-- номер вместо имени</span>
    $$ <span style="color:#3b6ac8">LANGUAGE</span> sql<span style="color:#323232">;</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">CREATE FUNCTION
    </pre></div>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span><span style="color:#1094a0">'Alice'</span><span style="color:#323232">);</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">     hello     
    ---------------
     Hello, Alice!
    (1 row)
    
    </pre></div>
    <p class="C">
    Но так лучше не делать, это неудобно.
    </p>
    <p class="C">
    Удалим функцию и создадим заново, добавив еще один параметр — обращение.
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">DROP FUNCTION</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span><span style="color:#a00050">text</span><span style="color:#323232">);</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">DROP FUNCTION
    </pre></div>
    <p class="C">
    Здесь мы использовали необязательное ключевое слово IN, обозначающее входной параметр. Предложение DEFAULT позволяет определить значение по умолчанию для параметра:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span><span style="color:#3b6ac8">IN</span> name <span style="color:#a00050">text</span><span style="color:#323232">,</span> <span style="color:#3b6ac8">IN</span> title <span style="color:#a00050">text</span> <span style="color:#3b6ac8">DEFAULT</span> <span style="color:#1094a0">'Mr'</span><span style="color:#323232">)</span>
    <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">text</span> <span style="color:#3b6ac8">AS</span> $$
    <span style="color:#3b6ac8">SELECT</span> <span style="color:#1094a0">'Hello, '</span> || title || <span style="color:#1094a0">' '</span> || name || <span style="color:#1094a0">'!'</span><span style="color:#323232">;</span>
    $$ <span style="color:#3b6ac8">LANGUAGE</span> sql<span style="color:#323232">;</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">CREATE FUNCTION
    </pre></div>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span><span style="color:#1094a0">'Alice'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'Mrs'</span><span style="color:#323232">);</span> <span style="color:#969696">-- указаны оба параметра</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">       hello       
    -------------------
     Hello, Mrs Alice!
    (1 row)
    
    </pre></div>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span><span style="color:#1094a0">'Bob'</span><span style="color:#323232">);</span> <span style="color:#969696">-- опущен параметр, имеющий значение по умолчанию</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">     hello      
    ----------------
     Hello, Mr Bob!
    (1 row)
    
    </pre></div>
    <p class="C">
    До сих пор мы вызывали функцию, указывая фактические параметры позиционным способом — в том порядке, в котором они определены при создании функции. Во&nbsp;многих стандартных функциях имена параметров не заданы, так что этот способ оказывается единственным.
    </p>
    <p class="C">
    Но если формальным параметрам даны имена, можно использовать их при указании фактических параметров. В этом случае параметры могут указываться в произвольном порядке:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span>title <span style="color:#323232">=&gt;</span> <span style="color:#1094a0">'Mrs'</span><span style="color:#323232">,</span> name <span style="color:#323232">=&gt;</span> <span style="color:#1094a0">'Alice'</span><span style="color:#323232">);</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">       hello       
    -------------------
     Hello, Mrs Alice!
    (1 row)
    
    </pre></div>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span>name <span style="color:#323232">=&gt;</span> <span style="color:#1094a0">'Bob'</span><span style="color:#323232">);</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">     hello      
    ----------------
     Hello, Mr Bob!
    (1 row)
    
    </pre></div>
    <p class="C">
    Такой способ удобен, когда порядок параметров неочевиден, особенно если их много.
    </p>
    <p class="C">
    Можно совмещать оба способа: часть параметров (начиная с первого) указать позиционно, а оставшиеся — по имени:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span><span style="color:#1094a0">'Alice'</span><span style="color:#323232">,</span> title <span style="color:#323232">=&gt;</span> <span style="color:#1094a0">'Mrs'</span><span style="color:#323232">);</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">       hello       
    -------------------
     Hello, Mrs Alice!
    (1 row)
    
    </pre></div>
    <p class="C">
    В случае, когда функция должна возвращать неопределенное значение, если хотя бы один из входных параметров не определен, ее можно объявить как строгую (STRICT). Тело функции при этом вообще не будет выполняться.
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">DROP FUNCTION</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span><span style="color:#a00050">text</span><span style="color:#323232">,</span> <span style="color:#a00050">text</span><span style="color:#323232">);</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">DROP FUNCTION
    </pre></div>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span><span style="color:#3b6ac8">IN</span> name <span style="color:#a00050">text</span><span style="color:#323232">,</span> <span style="color:#3b6ac8">IN</span> title <span style="color:#a00050">text</span> <span style="color:#3b6ac8">DEFAULT</span> <span style="color:#1094a0">'Mr'</span><span style="color:#323232">)</span>
    <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">text</span> <span style="color:#3b6ac8">AS</span> $$
    <span style="color:#3b6ac8">SELECT</span> <span style="color:#1094a0">'Hello, '</span> || title || <span style="color:#1094a0">' '</span> || name || <span style="color:#1094a0">'!'</span><span style="color:#323232">;</span>
    $$ <span style="color:#3b6ac8">LANGUAGE</span> sql <span style="color:#3b6ac8">STRICT</span><span style="color:#323232">;</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">CREATE FUNCTION
    </pre></div>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span><span style="color:#1094a0">'Alice'</span><span style="color:#323232">,</span> <span style="color:#3b6ac8">NULL</span><span style="color:#323232">);</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1"> hello 
    -------
     
    (1 row)
    
    </pre></div>
    <!-- end -->
    
    
    </body></html>


    <html><head>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF8">
        <style>
        p.C    { font-size: 80%; }
        li     { font-size: 80%; }
        h1     { font-size: 100%; font-weight: bold; padding-top: 1ex; padding-bottom: 1ex; }
        div.S1 { padding-left: 0px; font-weight: bold; page-break-inside: avoid; }
        div.S2 { padding-left: 20px; font-weight: bold; page-break-inside: avoid; border-left: 1px solid grey; }
        div.S3 { padding-left: 40px; font-weight: bold; page-break-inside: avoid; border-left: 3px double grey; }
        div.R1 { padding-left: 0px; page-break-inside: avoid; }
        div.R2 { padding-left: 20px; page-break-inside: avoid; border-left: 1px solid grey; }
        div.R3 { padding-left: 40px; page-break-inside: avoid; border-left: 3px double grey; }
        div.E  { padding-left: 0px; font-weight: bold; }
        div.R  { padding-left: 0px; }
        </style>
        </head>
        <body style="margin: 59.5px;">
        <!-- body -->
        <!-- 7 -->
        <h1>
        Функции с выходными параметрами
        </h1>
        <p class="C">
        Альтернативный способ вернуть значение — использовать выходной параметр.
        </p>
        <div class="S1">
        <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">DROP FUNCTION</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span><span style="color:#a00050">text</span><span style="color:#323232">,</span> <span style="color:#a00050">text</span><span style="color:#323232">);</span>
        </pre>
        </div>
        <div class="R1"><pre class="R1">DROP FUNCTION
        </pre></div>
        <div class="S1">
        <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span>
            <span style="color:#3b6ac8">IN</span> name <span style="color:#a00050">text</span><span style="color:#323232">,</span>
            <span style="color:#3b6ac8">OUT</span> <span style="color:#a00050">text</span> <span style="color:#969696">-- имя можно не указывать, если оно не нужно</span>
        <span style="color:#323232">)</span>
        <span style="color:#3b6ac8">AS</span> $$
        <span style="color:#3b6ac8">SELECT</span> <span style="color:#1094a0">'Hello, '</span> || name || <span style="color:#1094a0">'!'</span><span style="color:#323232">;</span>
        $$ <span style="color:#3b6ac8">LANGUAGE</span> sql<span style="color:#323232">;</span>
        </pre>
        </div>
        <div class="R1"><pre class="R1">CREATE FUNCTION
        </pre></div>
        <div class="S1">
        <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span><span style="color:#1094a0">'Alice'</span><span style="color:#323232">);</span>
        </pre>
        </div>
        <div class="R1"><pre class="R1">     hello     
        ---------------
         Hello, Alice!
        (1 row)
        
        </pre></div>
        <p class="C">
        Результат тот же самый.
        </p>
        <p class="C">
        Можно использовать и RETURNS, и OUT-параметр вместе — результат снова будет тем же:
        </p>
        <div class="S1">
        <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">DROP FUNCTION</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span><span style="color:#a00050">text</span><span style="color:#323232">);</span> <span style="color:#969696">-- OUT-параметры не указываем</span>
        </pre>
        </div>
        <div class="R1"><pre class="R1">DROP FUNCTION
        </pre></div>
        <div class="S1">
        <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span><span style="color:#3b6ac8">IN</span> name <span style="color:#a00050">text</span><span style="color:#323232">,</span> <span style="color:#3b6ac8">OUT</span> <span style="color:#a00050">text</span><span style="color:#323232">)</span>
        <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">text</span> <span style="color:#3b6ac8">AS</span> $$
        <span style="color:#3b6ac8">SELECT</span> <span style="color:#1094a0">'Hello, '</span> || name || <span style="color:#1094a0">'!'</span><span style="color:#323232">;</span>
        $$ <span style="color:#3b6ac8">LANGUAGE</span> sql<span style="color:#323232">;</span>
        </pre>
        </div>
        <div class="R1"><pre class="R1">CREATE FUNCTION
        </pre></div>
        <div class="S1">
        <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span><span style="color:#1094a0">'Alice'</span><span style="color:#323232">);</span>
        </pre>
        </div>
        <div class="R1"><pre class="R1">     hello     
        ---------------
         Hello, Alice!
        (1 row)
        
        </pre></div>
        <p class="C">
        Или даже так, использовав INOUT-параметр:
        </p>
        <div class="S1">
        <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">DROP FUNCTION</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span><span style="color:#a00050">text</span><span style="color:#323232">);</span>
        </pre>
        </div>
        <div class="R1"><pre class="R1">DROP FUNCTION
        </pre></div>
        <div class="S1">
        <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span><span style="color:#3b6ac8">INOUT</span> name <span style="color:#a00050">text</span><span style="color:#323232">)</span>
        <span style="color:#3b6ac8">AS</span> $$
        <span style="color:#3b6ac8">SELECT</span> <span style="color:#1094a0">'Hello, '</span> || name || <span style="color:#1094a0">'!'</span><span style="color:#323232">;</span>
        $$ <span style="color:#3b6ac8">LANGUAGE</span> sql<span style="color:#323232">;</span>
        </pre>
        </div>
        <div class="R1"><pre class="R1">CREATE FUNCTION
        </pre></div>
        <div class="S1">
        <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span><span style="color:#1094a0">'Alice'</span><span style="color:#323232">);</span>
        </pre>
        </div>
        <div class="R1"><pre class="R1">     hello     
        ---------------
         Hello, Alice!
        (1 row)
        
        </pre></div>
        <p class="C">
        Обратите внимание, что, в отличие от многих языков программирования, в PL/pgSQL фактическое значение, переданное SQL-функции в INOUT-параметре, никак не изменяется: мы передаем входное значение, а выходное возвращается функцией в качестве результата. Поэтому мы можем указать константу, хотя другие языки требовали бы переменную.
        </p>
        <p class="C">
        В то время как в RETURNS можно указать только одно значение, выходных параметров может быть несколько. Например:
        </p>
        <div class="S1">
        <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">DROP FUNCTION</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span><span style="color:#a00050">text</span><span style="color:#323232">);</span>
        </pre>
        </div>
        <div class="R1"><pre class="R1">DROP FUNCTION
        </pre></div>
        <div class="S1">
        <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span>
            <span style="color:#3b6ac8">IN</span> name <span style="color:#a00050">text</span><span style="color:#323232">,</span>
            <span style="color:#3b6ac8">OUT</span> greeting <span style="color:#a00050">text</span><span style="color:#323232">,</span>
            <span style="color:#3b6ac8">OUT</span> clock <span style="color:#a00050">timetz</span><span style="color:#323232">)</span>
        <span style="color:#3b6ac8">AS</span> $$
        <span style="color:#3b6ac8">SELECT</span> <span style="color:#1094a0">'Hello, '</span> || name || <span style="color:#1094a0">'!'</span><span style="color:#323232">,</span> <span style="color:#c73a69">current_time</span><span style="color:#323232">;</span>
        $$ <span style="color:#3b6ac8">LANGUAGE</span> sql<span style="color:#323232">;</span>
        </pre>
        </div>
        <div class="R1"><pre class="R1">CREATE FUNCTION
        </pre></div>
        <div class="S1">
        <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">hello</span><span style="color:#323232">(</span><span style="color:#1094a0">'Alice'</span><span style="color:#323232">);</span>
        </pre>
        </div>
        <div class="R1"><pre class="R1">                hello                 
        --------------------------------------
         ("Hello, Alice!",11:05:20.617553+03)
        (1 row)
        
        </pre></div>
        <p class="C">
        Действительно, наша функция вернула не одно значение, а сразу несколько.
        </p>
        <p class="C">
        Подробнее о такой возможности и составных типах мы будем говорить в теме «SQL. Составные типы».
        </p>
        <!-- end -->
        
        
        </body></html>

        <html><head>
            <meta http-equiv="Content-Type" content="text/html;charset=UTF8">
            <style>
            p.C    { font-size: 80%; }
            li     { font-size: 80%; }
            h1     { font-size: 100%; font-weight: bold; padding-top: 1ex; padding-bottom: 1ex; }
            div.S1 { padding-left: 0px; font-weight: bold; page-break-inside: avoid; }
            div.S2 { padding-left: 20px; font-weight: bold; page-break-inside: avoid; border-left: 1px solid grey; }
            div.S3 { padding-left: 40px; font-weight: bold; page-break-inside: avoid; border-left: 3px double grey; }
            div.R1 { padding-left: 0px; page-break-inside: avoid; }
            div.R2 { padding-left: 20px; page-break-inside: avoid; border-left: 1px solid grey; }
            div.R3 { padding-left: 40px; page-break-inside: avoid; border-left: 3px double grey; }
            div.E  { padding-left: 0px; font-weight: bold; }
            div.R  { padding-left: 0px; }
            </style>
            </head>
            <body style="margin: 59.5px;">
            <!-- body -->
            <!-- 9 -->
            <h1>
            Категории изменчивости и изоляция
            </h1>
            <p class="C">
            В целом использование функций внутри запросов не нарушает установленный уровень изоляции транзакции, но есть два момента, о которых полезно знать.
            </p>
            <p class="C">
            Во-первых, функции с изменчивостью volatile на уровне изоляции Read Committed приводят к рассогласованию данных внутри одного запроса.
            </p>
            <p class="C">
            Сделаем функцию, возвращающую число строк в таблице:
            </p>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE TABLE</span> <span style="color:#c73a69">t</span><span style="color:#323232">(</span>n <span style="color:#a00050">integer</span><span style="color:#323232">);</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1">CREATE TABLE
            </pre></div>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">cnt</span><span style="color:#323232">()</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">bigint</span>
            <span style="color:#3b6ac8">AS</span> $$
                <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">count</span><span style="color:#323232">(*)</span> <span style="color:#3b6ac8">FROM</span> t<span style="color:#323232">;</span>
            $$ <span style="color:#3b6ac8">VOLATILE LANGUAGE</span> sql<span style="color:#323232">;</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1">CREATE FUNCTION
            </pre></div>
            <p class="C">
            Теперь вызовем ее несколько раз с задержкой, а в параллельном сеансе вставим в таблицу строку.
            </p>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">BEGIN ISOLATION LEVEL READ COMMITTED</span><span style="color:#323232">;</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1">BEGIN
            </pre></div>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#323232">(</span><span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">count</span><span style="color:#323232">(*)</span> <span style="color:#3b6ac8">FROM</span> t<span style="color:#323232">),</span> <span style="color:#c73a69">cnt</span><span style="color:#323232">(),</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">)</span>
            <span style="color:#3b6ac8">FROM</span> <span style="color:#c73a69">generate_series</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">,</span><span style="color:#1094a0">4</span><span style="color:#323232">);</span>
            </pre>
            </div>
            <div class="S2">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">INSERT INTO</span> t <span style="color:#3b6ac8">VALUES</span> <span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">);</span>
            </pre>
            </div>
            <div class="R2"><pre class="R2">INSERT 0 1
            
            </pre></div>
            <div class="R1"><pre class="R1"> count | cnt | pg_sleep 
            -------+-----+----------
                 0 |   0 | 
                 0 |   0 | 
                 0 |   1 | 
                 0 |   1 | 
            (4 rows)
            
            </pre></div>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1">COMMIT
            </pre></div>
            <p class="C">
            При изменчивости stable или immutable, либо использовании более строгих уровней изоляции, такого не происходит.
            </p>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">ALTER FUNCTION</span> <span style="color:#c73a69">cnt</span><span style="color:#323232">()</span> <span style="color:#3b6ac8">STABLE</span><span style="color:#323232">;</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1">ALTER FUNCTION
            </pre></div>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">TRUNCATE</span> t<span style="color:#323232">;</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1">TRUNCATE TABLE
            </pre></div>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">BEGIN ISOLATION LEVEL READ COMMITTED</span><span style="color:#323232">;</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1">BEGIN
            </pre></div>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#323232">(</span><span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">count</span><span style="color:#323232">(*)</span> <span style="color:#3b6ac8">FROM</span> t<span style="color:#323232">),</span> <span style="color:#c73a69">cnt</span><span style="color:#323232">(),</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">)</span>
            <span style="color:#3b6ac8">FROM</span> <span style="color:#c73a69">generate_series</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">,</span><span style="color:#1094a0">4</span><span style="color:#323232">);</span>
            </pre>
            </div>
            <div class="S2">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">INSERT INTO</span> t <span style="color:#3b6ac8">VALUES</span> <span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">);</span>
            </pre>
            </div>
            <div class="R2"><pre class="R2">INSERT 0 1
            
            </pre></div>
            <div class="R1"><pre class="R1"> count | cnt | pg_sleep 
            -------+-----+----------
                 0 |   0 | 
                 0 |   0 | 
                 0 |   0 | 
                 0 |   0 | 
            (4 rows)
            
            </pre></div>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1">COMMIT
            </pre></div>
            <hr size="0" style="border-top: 1px dashed grey; border-bottom: 0;">
            <p class="C">
            Второй момент связан с видимостью изменений, сделанных собственной транзакцией.
            </p>
            <p class="C">
            Функции с изменчивостью volatile видят все изменения, в том числе сделанные текущим, еще не завершенным оператором SQL.
            </p>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">ALTER FUNCTION</span> <span style="color:#c73a69">cnt</span><span style="color:#323232">()</span> <span style="color:#3b6ac8">VOLATILE</span><span style="color:#323232">;</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1">ALTER FUNCTION
            </pre></div>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">TRUNCATE</span> t<span style="color:#323232">;</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1">TRUNCATE TABLE
            </pre></div>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">INSERT INTO</span> t <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">cnt</span><span style="color:#323232">()</span> <span style="color:#3b6ac8">FROM</span> <span style="color:#c73a69">generate_series</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">,</span><span style="color:#1094a0">5</span><span style="color:#323232">);</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1">INSERT 0 5
            </pre></div>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#323232">*</span> <span style="color:#3b6ac8">FROM</span> t<span style="color:#323232">;</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1"> n 
            ---
             0
             1
             2
             3
             4
            (5 rows)
            
            </pre></div>
            <p class="C">
            Это верно для любых уровней изоляции.
            </p>
            <p class="C">
            Функции с изменчивостью stable или immutable видят изменения только уже завершенных операторов.
            </p>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">ALTER FUNCTION</span> <span style="color:#c73a69">cnt</span><span style="color:#323232">()</span> <span style="color:#3b6ac8">STABLE</span><span style="color:#323232">;</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1">ALTER FUNCTION
            </pre></div>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">TRUNCATE</span> t<span style="color:#323232">;</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1">TRUNCATE TABLE
            </pre></div>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">INSERT INTO</span> t <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">cnt</span><span style="color:#323232">()</span> <span style="color:#3b6ac8">FROM</span> <span style="color:#c73a69">generate_series</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">,</span><span style="color:#1094a0">5</span><span style="color:#323232">);</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1">INSERT 0 5
            </pre></div>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#323232">*</span> <span style="color:#3b6ac8">FROM</span> t<span style="color:#323232">;</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1"> n 
            ---
             0
             0
             0
             0
             0
            (5 rows)
            
            </pre></div>
            <hr size="0" style="border-top: 1px dashed grey; border-bottom: 0;">
            <h1>
            Категории изменчивости и оптимизация
            </h1>
            <p class="C">
            Благодаря дополнительной информации о поведении функции, которую дает указание категории изменчивости, оптимизатор может сэкономить на вызовах функции.
            </p>
            <p class="C">
            Для экспериментов создадим функцию, возвращающую случайное число:
            </p>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">rnd</span><span style="color:#323232">()</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">float</span>
            <span style="color:#3b6ac8">AS</span> $$
                <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">random</span><span style="color:#323232">();</span>
            $$ <span style="color:#3b6ac8">VOLATILE LANGUAGE</span> sql<span style="color:#323232">;</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1">CREATE FUNCTION
            </pre></div>
            <p class="C">
            Проверим план выполнения следующего запроса:
            </p>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">EXPLAIN</span> <span style="color:#323232">(</span>costs off<span style="color:#323232">)</span>
            <span style="color:#3b6ac8">SELECT</span> <span style="color:#323232">*</span> <span style="color:#3b6ac8">FROM</span> <span style="color:#c73a69">generate_series</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">,</span><span style="color:#1094a0">10</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">WHERE</span> <span style="color:#c73a69">rnd</span><span style="color:#323232">() &gt;</span> <span style="color:#1094a0">0.5</span><span style="color:#323232">;</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1">                   QUERY PLAN                   
            ------------------------------------------------
             Function Scan on generate_series
               Filter: (random() &gt; '0.5'::double precision)
            (2 rows)
            
            </pre></div>
            <p class="C">
            В плане мы видим «честное» обращение к функции generate_series; каждая строка результата сравнивается со случайным числом и при необходимости отбрасывается фильтром.
            </p>
            <p class="C">
            В этом можно убедиться и воочию (ожидаем в среднем получить 5 строк):
            </p>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#323232">*</span> <span style="color:#3b6ac8">FROM</span> <span style="color:#c73a69">generate_series</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">,</span><span style="color:#1094a0">10</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">WHERE</span> <span style="color:#c73a69">rnd</span><span style="color:#323232">() &gt;</span> <span style="color:#1094a0">0.5</span><span style="color:#323232">;</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1"> generate_series 
            -----------------
                           1
                           2
                           4
                           6
                           9
            (5 rows)
            
            </pre></div>
            <p class="C">
            Функция с изменчивостью stable будет вызвана всего один раз — поскольку мы фактически указали, что ее значение не может измениться в пределах оператора:
            </p>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">ALTER FUNCTION</span> <span style="color:#c73a69">rnd</span><span style="color:#323232">()</span> <span style="color:#3b6ac8">STABLE</span><span style="color:#323232">;</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1">ALTER FUNCTION
            </pre></div>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">EXPLAIN</span> <span style="color:#323232">(</span>costs off<span style="color:#323232">)</span>
            <span style="color:#3b6ac8">SELECT</span> <span style="color:#323232">*</span> <span style="color:#3b6ac8">FROM</span> <span style="color:#c73a69">generate_series</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">,</span><span style="color:#1094a0">10</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">WHERE</span> <span style="color:#c73a69">rnd</span><span style="color:#323232">() &gt;</span> <span style="color:#1094a0">0.5</span><span style="color:#323232">;</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1">                      QUERY PLAN                      
            ------------------------------------------------------
             Result
               One-Time Filter: (rnd() &gt; '0.5'::double precision)
               -&gt;  Function Scan on generate_series
            (3 rows)
            
            </pre></div>
            <p class="C">
            Наконец, изменчивость immutable позволяет вычислить функции еще на этапе планирования, поэтому во время выполнения никакие фильтры не нужны:
            </p>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">ALTER FUNCTION</span> <span style="color:#c73a69">rnd</span><span style="color:#323232">()</span> <span style="color:#3b6ac8">IMMUTABLE</span><span style="color:#323232">;</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1">ALTER FUNCTION
            </pre></div>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">EXPLAIN</span> <span style="color:#323232">(</span>costs off<span style="color:#323232">)</span>
            <span style="color:#3b6ac8">SELECT</span> <span style="color:#323232">*</span> <span style="color:#3b6ac8">FROM</span> <span style="color:#c73a69">generate_series</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">,</span><span style="color:#1094a0">10</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">WHERE</span> <span style="color:#c73a69">rnd</span><span style="color:#323232">() &gt;</span> <span style="color:#1094a0">0.5</span><span style="color:#323232">;</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1">        QUERY PLAN        
            --------------------------
             Result
               One-Time Filter: false
            (2 rows)
            
            </pre></div>
            <p class="C">
            Ответственность «за дачу заведомо ложных показаний» лежит на разработчике.
            </p>
            <hr size="0" style="border-top: 1px dashed grey; border-bottom: 0;">
            <h1>
            Подстановка тела функции в SQL-запрос
            </h1>
            <p class="C">
            В некоторых (очень простых) случаях тело функции на языке SQL может быть подставлено прямо в основной SQL-оператор на этапе разбора запроса. В этом случае время на вызов функции не тратится.
            </p>
            <p class="C">
            Упрощенно требуется выполнение следующих условий:
            </p>
            <ul class="U">
            <li>
            тело функции состоит из одного оператора SELECT;
            </li>
            <li>
            нет обращений к таблицам, отсутствуют подзапросы, группировки и т. п.;
            </li>
            <li>
            возвращаемое значение должно быть одно;
            </li>
            <li>
            вызываемые функции не должны противоречить указанной категории изменчивости.
            </li>
            </ul>
            <p class="C">
            Пример мы уже видели: наша функция rnd(), объявленная volatile.
            </p>
            <p class="C">
            Посмотрим еще раз.
            </p>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">ALTER FUNCTION</span> <span style="color:#c73a69">rnd</span><span style="color:#323232">()</span> <span style="color:#3b6ac8">VOLATILE</span><span style="color:#323232">;</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1">ALTER FUNCTION
            </pre></div>
            <div class="S1">
            <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">EXPLAIN</span> <span style="color:#323232">(</span>costs off<span style="color:#323232">)</span>
            <span style="color:#3b6ac8">SELECT</span> <span style="color:#323232">*</span> <span style="color:#3b6ac8">FROM</span> <span style="color:#c73a69">generate_series</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">,</span><span style="color:#1094a0">10</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">WHERE</span> <span style="color:#c73a69">rnd</span><span style="color:#323232">() &gt;</span> <span style="color:#1094a0">0.5</span><span style="color:#323232">;</span>
            </pre>
            </div>
            <div class="R1"><pre class="R1">                   QUERY PLAN                   
            ------------------------------------------------
             Function Scan on generate_series
               Filter: (random() &gt; '0.5'::double precision)
            (2 rows)
            
            </pre></div>
            <p class="C">
            В фильтре упоминается только функция random(), которая вызывается напрямую, минуя «обертку» в виде функции rnd().
            </p>
            <!-- end -->
            
            
            </body></html>



