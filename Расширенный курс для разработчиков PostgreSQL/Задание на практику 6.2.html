<html><head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF8">
    <style>
    p.C    { font-size: 80%; }
    li     { font-size: 80%; }
    h1     { font-size: 100%; font-weight: bold; padding-top: 1ex; padding-bottom: 1ex; }
    div.S1 { padding-left: 0px; font-weight: bold; page-break-inside: avoid; }
    div.S2 { padding-left: 20px; font-weight: bold; page-break-inside: avoid; border-left: 1px solid grey; }
    div.S3 { padding-left: 40px; font-weight: bold; page-break-inside: avoid; border-left: 3px double grey; }
    div.R1 { padding-left: 0px; page-break-inside: avoid; }
    div.R2 { padding-left: 20px; page-break-inside: avoid; border-left: 1px solid grey; }
    div.R3 { padding-left: 40px; page-break-inside: avoid; border-left: 3px double grey; }
    div.E  { padding-left: 0px; font-weight: bold; }
    div.R  { padding-left: 0px; }
    </style>
    </head>
    <body style="margin: 59.5px;">
    <!-- body -->
    <!--  -->
    <h1>
    1. Устранение дубликатов
    </h1>
    <p class="C">
    В целях проверки добавим второго Пушкина:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">INSERT INTO</span> <span style="color:#c73a69">authors</span><span style="color:#323232">(</span>last_name<span style="color:#323232">,</span> first_name<span style="color:#323232">,</span> middle_name<span style="color:#323232">)</span>
        <span style="color:#3b6ac8">VALUES</span> <span style="color:#323232">(</span><span style="color:#1094a0">'Пушкин'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'Александр'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'Сергеевич'</span><span style="color:#323232">);</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">INSERT 0 1
    </pre></div>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> last_name<span style="color:#323232">,</span> first_name<span style="color:#323232">,</span> middle_name<span style="color:#323232">,</span> <span style="color:#c73a69">count</span><span style="color:#323232">(*)</span>
    <span style="color:#3b6ac8">FROM</span> authors
    <span style="color:#3b6ac8">GROUP BY</span> last_name<span style="color:#323232">,</span> first_name<span style="color:#323232">,</span> middle_name<span style="color:#323232">;</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1"> last_name  | first_name | middle_name | count 
    ------------+------------+-------------+-------
     Свифт      | Джонатан   |             |     1
     Стругацкий | Борис      | Натанович   |     1
     Пушкин     | Александр  | Сергеевич   |     2
     Стругацкий | Аркадий    | Натанович   |     1
     Толстой    | Лев        | Николаевич  |     1
     Тургенев   | Иван       | Сергеевич   |     1
    (6 rows)
    
    </pre></div>
    <p class="C">
    Задачу устранения дубликатов можно решить разными способами. Например, так:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE PROCEDURE</span> <span style="color:#c73a69">authors_dedup</span><span style="color:#323232">()</span>
    <span style="color:#3b6ac8">AS</span> $$
    <span style="color:#3b6ac8">DELETE FROM</span> authors
    <span style="color:#3b6ac8">WHERE</span> author_id <span style="color:#3b6ac8">IN</span> <span style="color:#323232">(</span>
        <span style="color:#3b6ac8">SELECT</span> author_id
        <span style="color:#3b6ac8">FROM</span> <span style="color:#323232">(</span>
            <span style="color:#3b6ac8">SELECT</span> author_id<span style="color:#323232">,</span>
                   <span style="color:#c73a69">row_number</span><span style="color:#323232">()</span> <span style="color:#3b6ac8">OVER</span> <span style="color:#323232">(</span>
                       <span style="color:#3b6ac8">PARTITION BY</span> first_name<span style="color:#323232">,</span> last_name<span style="color:#323232">,</span> middle_name
                       <span style="color:#3b6ac8">ORDER BY</span> author_id
                   <span style="color:#323232">)</span> <span style="color:#3b6ac8">AS</span> rn
            <span style="color:#3b6ac8">FROM</span> authors
        <span style="color:#323232">)</span> t
        <span style="color:#3b6ac8">WHERE</span> t.rn <span style="color:#323232">&gt;</span> <span style="color:#1094a0">1</span>
    <span style="color:#323232">);</span>
    $$ <span style="color:#3b6ac8">LANGUAGE</span> sql<span style="color:#323232">;</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">CREATE PROCEDURE
    </pre></div>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CALL</span> <span style="color:#c73a69">authors_dedup</span><span style="color:#323232">();</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">CALL
    </pre></div>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> last_name<span style="color:#323232">,</span> first_name<span style="color:#323232">,</span> middle_name<span style="color:#323232">,</span> <span style="color:#c73a69">count</span><span style="color:#323232">(*)</span>
    <span style="color:#3b6ac8">FROM</span> authors
    <span style="color:#3b6ac8">GROUP BY</span> last_name<span style="color:#323232">,</span> first_name<span style="color:#323232">,</span> middle_name<span style="color:#323232">;</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1"> last_name  | first_name | middle_name | count 
    ------------+------------+-------------+-------
     Свифт      | Джонатан   |             |     1
     Стругацкий | Борис      | Натанович   |     1
     Пушкин     | Александр  | Сергеевич   |     1
     Стругацкий | Аркадий    | Натанович   |     1
     Толстой    | Лев        | Николаевич  |     1
     Тургенев   | Иван       | Сергеевич   |     1
    (6 rows)
    
    </pre></div>
    <h1>
    2. Ограничение целостности
    </h1>
    <p class="C">
    Создать подходящее ограничение целостности мешает тот факт, что отчество может быть неопределенным (NULL). Неопределенные значения считаются различными, поэтому ограничение
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#3b6ac8">UNIQUE</span><span style="color:#323232">(</span>first_name<span style="color:#323232">,</span> last_name<span style="color:#323232">,</span> middle_name<span style="color:#323232">)</span>
    </pre>
    </div>
    <p class="C">
    не помешает добавить второго Джонатана Свифта без отчества.
    </p>
    <p class="C">
    Задачу можно решить, создав уникальный индекс:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE UNIQUE INDEX</span> authors_full_name_idx <span style="color:#3b6ac8">ON</span> <span style="color:#c73a69">authors</span><span style="color:#323232">(</span>
        last_name<span style="color:#323232">,</span> first_name<span style="color:#323232">,</span> <span style="color:#c73a69">coalesce</span><span style="color:#323232">(</span>middle_name<span style="color:#323232">,</span><span style="color:#1094a0">''</span><span style="color:#323232">)</span>
    <span style="color:#323232">);</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">CREATE INDEX
    </pre></div>
    <p class="C">
    Проверим:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">INSERT INTO</span> <span style="color:#c73a69">authors</span><span style="color:#323232">(</span>last_name<span style="color:#323232">,</span> first_name<span style="color:#323232">)</span>
        <span style="color:#3b6ac8">VALUES</span> <span style="color:#323232">(</span><span style="color:#1094a0">'Свифт'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'Джонатан'</span><span style="color:#323232">);</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">ERROR:  duplicate key value violates unique constraint "authors_full_name_idx"
    DETAIL:  Key (last_name, first_name, COALESCE(middle_name, ''::text))=(Свифт, Джонатан, ) already exists.
    </pre></div>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">INSERT INTO</span> <span style="color:#c73a69">authors</span><span style="color:#323232">(</span>last_name<span style="color:#323232">,</span> first_name<span style="color:#323232">,</span> middle_name<span style="color:#323232">)</span>
        <span style="color:#3b6ac8">VALUES</span> <span style="color:#323232">(</span><span style="color:#1094a0">'Пушкин'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'Александр'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'Сергеевич'</span><span style="color:#323232">);</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">ERROR:  duplicate key value violates unique constraint "authors_full_name_idx"
    DETAIL:  Key (last_name, first_name, COALESCE(middle_name, ''::text))=(Пушкин, Александр, Сергеевич) already exists.
    </pre></div>
    <!-- end -->
    
    
    </body></html>