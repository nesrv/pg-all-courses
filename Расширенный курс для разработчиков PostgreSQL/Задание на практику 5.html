<html><head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF8">
    <style>
    p.C    { font-size: 80%; }
    li     { font-size: 80%; }
    h1     { font-size: 100%; font-weight: bold; padding-top: 1ex; padding-bottom: 1ex; }
    div.S1 { padding-left: 0px; font-weight: bold; page-break-inside: avoid; }
    div.S2 { padding-left: 20px; font-weight: bold; page-break-inside: avoid; border-left: 1px solid grey; }
    div.S3 { padding-left: 40px; font-weight: bold; page-break-inside: avoid; border-left: 3px double grey; }
    div.R1 { padding-left: 0px; page-break-inside: avoid; }
    div.R2 { padding-left: 20px; page-break-inside: avoid; border-left: 1px solid grey; }
    div.R3 { padding-left: 40px; page-break-inside: avoid; border-left: 3px double grey; }
    div.E  { padding-left: 0px; font-weight: bold; }
    div.R  { padding-left: 0px; }
    </style>
    </head>
    <body style="margin: 59.5px;">
    <!-- body -->
    <!--  -->
    <h1>
    1. Схема и путь поиска
    </h1>
    <div class="E">
    <pre style="color:#323232; background-color:#ffffff;  ">student$ <span style="color:#00a150">psql</span> bookstore
    </pre>
    </div>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE SCHEMA</span> bookstore<span style="color:#323232">;</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">CREATE SCHEMA
    </pre></div>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">ALTER DATABASE</span> bookstore <span style="color:#3b6ac8">SET</span> search_path <span style="color:#323232">=</span> bookstore<span style="color:#323232">,</span> public<span style="color:#323232">;</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">ALTER DATABASE
    </pre></div>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\c</span> bookstore
    </pre>
    </div>
    <div class="R1"><pre class="R1">You are now connected to database "bookstore" as user "student".
    </pre></div>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SHOW</span> search_path<span style="color:#323232">;</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">    search_path    
    -------------------
     bookstore, public
    (1 row)
    
    </pre></div>
    <h1>
    2. Таблицы
    </h1>
    <p class="C">
    Авторы:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE TABLE</span> <span style="color:#c73a69">authors</span><span style="color:#323232">(</span>
        author_id <span style="color:#a00050">integer</span> <span style="color:#3b6ac8">PRIMARY KEY GENERATED ALWAYS AS IDENTITY</span><span style="color:#323232">,</span>
        last_name <span style="color:#a00050">text</span> <span style="color:#3b6ac8">NOT NULL</span><span style="color:#323232">,</span>
        first_name <span style="color:#a00050">text</span> <span style="color:#3b6ac8">NOT NULL</span><span style="color:#323232">,</span>
        middle_name <span style="color:#a00050">text</span>
    <span style="color:#323232">);</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">CREATE TABLE
    </pre></div>
    <p class="C">
    Книги:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE TABLE</span> <span style="color:#c73a69">books</span><span style="color:#323232">(</span>
        book_id <span style="color:#a00050">integer</span> <span style="color:#3b6ac8">PRIMARY KEY GENERATED ALWAYS AS IDENTITY</span><span style="color:#323232">,</span>
        title <span style="color:#a00050">text</span> <span style="color:#3b6ac8">NOT NULL</span>
    <span style="color:#323232">);</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">CREATE TABLE
    </pre></div>
    <p class="C">
    Авторство:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE TABLE</span> <span style="color:#c73a69">authorship</span><span style="color:#323232">(</span>
        book_id <span style="color:#a00050">integer</span> <span style="color:#3b6ac8">REFERENCES</span> books<span style="color:#323232">,</span>
        author_id <span style="color:#a00050">integer</span> <span style="color:#3b6ac8">REFERENCES</span> authors<span style="color:#323232">,</span>
        seq_num <span style="color:#a00050">integer</span> <span style="color:#3b6ac8">NOT NULL</span><span style="color:#323232">,</span>
        <span style="color:#3b6ac8">PRIMARY KEY</span> <span style="color:#323232">(</span>book_id<span style="color:#323232">,</span>author_id<span style="color:#323232">)</span>
    <span style="color:#323232">);</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">CREATE TABLE
    </pre></div>
    <p class="C">
    Операции:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE TABLE</span> <span style="color:#c73a69">operations</span><span style="color:#323232">(</span>
        operation_id <span style="color:#a00050">integer</span> <span style="color:#3b6ac8">PRIMARY KEY GENERATED ALWAYS AS IDENTITY</span><span style="color:#323232">,</span>
        book_id <span style="color:#a00050">integer</span> <span style="color:#3b6ac8">NOT NULL REFERENCES</span> books<span style="color:#323232">,</span>
        qty_change <span style="color:#a00050">integer</span> <span style="color:#3b6ac8">NOT NULL</span><span style="color:#323232">,</span>
        date_created <span style="color:#a00050">date</span> <span style="color:#3b6ac8">NOT NULL DEFAULT</span> <span style="color:#c73a69">current_date</span>
    <span style="color:#323232">);</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">CREATE TABLE
    </pre></div>
    <h1>
    3. Данные
    </h1>
    <p class="C">
    Авторы:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">INSERT INTO</span> <span style="color:#c73a69">authors</span><span style="color:#323232">(</span>last_name<span style="color:#323232">,</span> first_name<span style="color:#323232">,</span> middle_name<span style="color:#323232">)</span>
    <span style="color:#3b6ac8">VALUES</span> 
        <span style="color:#323232">(</span><span style="color:#1094a0">'Пушкин'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'Александр'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'Сергеевич'</span><span style="color:#323232">),</span>
        <span style="color:#323232">(</span><span style="color:#1094a0">'Тургенев'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'Иван'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'Сергеевич'</span><span style="color:#323232">),</span>
        <span style="color:#323232">(</span><span style="color:#1094a0">'Стругацкий'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'Борис'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'Натанович'</span><span style="color:#323232">),</span>
        <span style="color:#323232">(</span><span style="color:#1094a0">'Стругацкий'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'Аркадий'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'Натанович'</span><span style="color:#323232">),</span>
        <span style="color:#323232">(</span><span style="color:#1094a0">'Толстой'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'Лев'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'Николаевич'</span><span style="color:#323232">),</span>
        <span style="color:#323232">(</span><span style="color:#1094a0">'Свифт'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'Джонатан'</span><span style="color:#323232">,</span> <span style="color:#3b6ac8">NULL</span><span style="color:#323232">);</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">INSERT 0 6
    </pre></div>
    <p class="C">
    Книги:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">INSERT INTO</span> <span style="color:#c73a69">books</span><span style="color:#323232">(</span>title<span style="color:#323232">)</span>
    <span style="color:#3b6ac8">VALUES</span>
        <span style="color:#323232">(</span><span style="color:#1094a0">'Сказка о царе Салтане'</span><span style="color:#323232">),</span>
        <span style="color:#323232">(</span><span style="color:#1094a0">'Муму'</span><span style="color:#323232">),</span>
        <span style="color:#323232">(</span><span style="color:#1094a0">'Трудно быть богом'</span><span style="color:#323232">),</span>
        <span style="color:#323232">(</span><span style="color:#1094a0">'Война и мир'</span><span style="color:#323232">),</span>
        <span style="color:#323232">(</span><span style="color:#1094a0">'Путешествия в некоторые удаленные страны мира в четырех частях: сочинение Лемюэля Гулливера, сначала хирурга, а затем капитана нескольких кораблей'</span><span style="color:#323232">),</span>
        <span style="color:#323232">(</span><span style="color:#1094a0">'Хрестоматия'</span><span style="color:#323232">);</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">INSERT 0 6
    </pre></div>
    <p class="C">
    Авторство:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">INSERT INTO</span> <span style="color:#c73a69">authorship</span><span style="color:#323232">(</span>book_id<span style="color:#323232">,</span> author_id<span style="color:#323232">,</span> seq_num<span style="color:#323232">)</span> 
    <span style="color:#3b6ac8">VALUES</span>
        <span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">,</span> <span style="color:#1094a0">1</span><span style="color:#323232">,</span> <span style="color:#1094a0">1</span><span style="color:#323232">),</span>
        <span style="color:#323232">(</span><span style="color:#1094a0">2</span><span style="color:#323232">,</span> <span style="color:#1094a0">2</span><span style="color:#323232">,</span> <span style="color:#1094a0">1</span><span style="color:#323232">),</span>
        <span style="color:#323232">(</span><span style="color:#1094a0">3</span><span style="color:#323232">,</span> <span style="color:#1094a0">3</span><span style="color:#323232">,</span> <span style="color:#1094a0">2</span><span style="color:#323232">),</span>
        <span style="color:#323232">(</span><span style="color:#1094a0">3</span><span style="color:#323232">,</span> <span style="color:#1094a0">4</span><span style="color:#323232">,</span> <span style="color:#1094a0">1</span><span style="color:#323232">),</span>
        <span style="color:#323232">(</span><span style="color:#1094a0">4</span><span style="color:#323232">,</span> <span style="color:#1094a0">5</span><span style="color:#323232">,</span> <span style="color:#1094a0">1</span><span style="color:#323232">),</span>
        <span style="color:#323232">(</span><span style="color:#1094a0">5</span><span style="color:#323232">,</span> <span style="color:#1094a0">6</span><span style="color:#323232">,</span> <span style="color:#1094a0">1</span><span style="color:#323232">),</span>
        <span style="color:#323232">(</span><span style="color:#1094a0">6</span><span style="color:#323232">,</span> <span style="color:#1094a0">1</span><span style="color:#323232">,</span> <span style="color:#1094a0">1</span><span style="color:#323232">),</span>
        <span style="color:#323232">(</span><span style="color:#1094a0">6</span><span style="color:#323232">,</span> <span style="color:#1094a0">5</span><span style="color:#323232">,</span> <span style="color:#1094a0">2</span><span style="color:#323232">),</span>
        <span style="color:#323232">(</span><span style="color:#1094a0">6</span><span style="color:#323232">,</span> <span style="color:#1094a0">2</span><span style="color:#323232">,</span> <span style="color:#1094a0">3</span><span style="color:#323232">);</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">INSERT 0 9
    </pre></div>
    <p class="C">
    Операции.
    </p>
    <p class="C">
    Другой способ вставки данных в таблицу — команда COPY. Она обычно используется, если нужно загрузить большой объем информации. Но в этом случае надо не забыть «передвинуть» значение последовательности:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">COPY</span> <span style="color:#c73a69">operations</span> <span style="color:#323232">(</span>operation_id<span style="color:#323232">,</span> book_id<span style="color:#323232">,</span> qty_change<span style="color:#323232">)</span> <span style="color:#3b6ac8">FROM</span> stdin<span style="color:#323232">;</span>
    <span style="color:#1094a0">1	1	10</span>
    <span style="color:#1094a0">2	1	10</span>
    <span style="color:#1094a0">3	1</span>	<span style="color:#323232">-</span><span style="color:#1094a0">1</span>
    \.
    </pre>
    </div>
    <div class="R1"><pre class="R1">COPY 3
    </pre></div>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> pg_catalog.<span style="color:#c73a69">setval</span><span style="color:#323232">(</span><span style="color:#1094a0">'operations_operation_id_seq'</span><span style="color:#323232">,</span> <span style="color:#1094a0">3</span><span style="color:#323232">,</span> <span style="color:#00a150">true</span><span style="color:#323232">);</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1"> setval 
    --------
          3
    (1 row)
    
    </pre></div>
    <h1>
    4. Представления
    </h1>
    <p class="C">
    Представление для авторов:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE VIEW</span> authors_v <span style="color:#3b6ac8">AS</span>
    <span style="color:#3b6ac8">SELECT</span> a.author_id<span style="color:#323232">,</span>
           a.last_name || <span style="color:#1094a0">' '</span> ||
           a.first_name ||
           <span style="color:#c73a69">coalesce</span><span style="color:#323232">(</span><span style="color:#1094a0">' '</span> || <span style="color:#c73a69">nullif</span><span style="color:#323232">(</span>a.middle_name<span style="color:#323232">,</span> <span style="color:#1094a0">''</span><span style="color:#323232">),</span> <span style="color:#1094a0">''</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">AS</span> display_name
    <span style="color:#3b6ac8">FROM</span>   authors a<span style="color:#323232">;</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">CREATE VIEW
    </pre></div>
    <p class="C">
    Представление для каталога:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE VIEW</span> catalog_v <span style="color:#3b6ac8">AS</span>
    <span style="color:#3b6ac8">SELECT</span> b.book_id<span style="color:#323232">,</span>
           b.title <span style="color:#3b6ac8">AS</span> display_name
    <span style="color:#3b6ac8">FROM</span>   books b<span style="color:#323232">;</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">CREATE VIEW
    </pre></div>
    <p class="C">
    Представление для операций:
    </p>
    <div class="S1">
    <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE VIEW</span> operations_v <span style="color:#3b6ac8">AS</span>
    <span style="color:#3b6ac8">SELECT</span> book_id<span style="color:#323232">,</span>
           <span style="color:#3b6ac8">CASE</span>
               <span style="color:#3b6ac8">WHEN</span> qty_change <span style="color:#323232">&gt;</span> <span style="color:#1094a0">0</span> <span style="color:#3b6ac8">THEN</span> <span style="color:#1094a0">'Поступление'</span>
               <span style="color:#3b6ac8">ELSE</span> <span style="color:#1094a0">'Покупка'</span>
           <span style="color:#3b6ac8">END</span> op_type<span style="color:#323232">,</span> 
           <span style="color:#c73a69">abs</span><span style="color:#323232">(</span>qty_change<span style="color:#323232">)</span> qty_change<span style="color:#323232">,</span> 
           <span style="color:#c73a69">to_char</span><span style="color:#323232">(</span>date_created<span style="color:#323232">,</span> <span style="color:#1094a0">'DD.MM.YYYY'</span><span style="color:#323232">)</span> date_created
    <span style="color:#3b6ac8">FROM</span>   operations
    <span style="color:#3b6ac8">ORDER BY</span> operation_id<span style="color:#323232">;</span>
    </pre>
    </div>
    <div class="R1"><pre class="R1">CREATE VIEW
    </pre></div>
    <!-- end -->
    
    
    </body></html>