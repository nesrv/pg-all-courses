<html><head>
       <meta http-equiv="Content-Type" content="text/html;charset=UTF8">
       <style>
       p.C    { font-size: 80%; }
       li     { font-size: 80%; }
       h1     { font-size: 100%; font-weight: bold; padding-top: 1ex; padding-bottom: 1ex; }
       div.S1 { padding-left: 0px; font-weight: bold; page-break-inside: avoid; }
       div.S2 { padding-left: 20px; font-weight: bold; page-break-inside: avoid; border-left: 1px solid grey; }
       div.S3 { padding-left: 40px; font-weight: bold; page-break-inside: avoid; border-left: 3px double grey; }
       div.R1 { padding-left: 0px; page-break-inside: avoid; }
       div.R2 { padding-left: 20px; page-break-inside: avoid; border-left: 1px solid grey; }
       div.R3 { padding-left: 40px; page-break-inside: avoid; border-left: 3px double grey; }
       div.E  { padding-left: 0px; font-weight: bold; }
       div.R  { padding-left: 0px; }
       </style>
       </head>
       <body style="margin: 59.5px;">
       <!-- body -->
       <!--  -->
       <h1>
       1. Случайная временная отметка
       </h1>
       <p class="C">
       Функция с двумя временными отметками:
       </p>
       <div class="S1">
       <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">rnd_timestamp</span><span style="color:#323232">(</span>t_start <span style="color:#a00050">timestamptz</span><span style="color:#323232">,</span> t_end <span style="color:#a00050">timestamptz</span><span style="color:#323232">)</span>
       <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">timestamptz</span>
       <span style="color:#3b6ac8">AS</span> $$
           <span style="color:#3b6ac8">SELECT</span> t_start <span style="color:#323232">+ (</span>t_end <span style="color:#323232">-</span> t_start<span style="color:#323232">) *</span> <span style="color:#c73a69">random</span><span style="color:#323232">();</span>
       $$ <span style="color:#3b6ac8">VOLATILE LANGUAGE</span> sql<span style="color:#323232">;</span>
       </pre>
       </div>
       <div class="R1"><pre class="R1">CREATE FUNCTION
       </pre></div>
       <p class="C">
       Категория изменчивости — volatile. Используется функция random, поэтому функция будет возвращать разные значения при одних и тех же входных параметрах.
       </p>
       <div class="S1">
       <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">current_timestamp</span><span style="color:#323232">,</span>
           <span style="color:#c73a69">rnd_timestamp</span><span style="color:#323232">(</span>
               <span style="color:#c73a69">current_timestamp</span><span style="color:#323232">,</span>
               <span style="color:#c73a69">current_timestamp</span> <span style="color:#323232">+</span> <span style="color:#a00050">interval</span> <span style="color:#1094a0">'1 hour'</span>
           <span style="color:#323232">)</span>
       <span style="color:#3b6ac8">FROM</span> <span style="color:#c73a69">generate_series</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">,</span><span style="color:#1094a0">10</span><span style="color:#323232">);</span>
       </pre>
       </div>
       <div class="R1"><pre class="R1">       current_timestamp       |         rnd_timestamp         
       -------------------------------+-------------------------------
        2023-07-26 11:11:13.193191+03 | 2023-07-26 11:41:41.90775+03
        2023-07-26 11:11:13.193191+03 | 2023-07-26 12:07:48.158397+03
        2023-07-26 11:11:13.193191+03 | 2023-07-26 12:01:19.254117+03
        2023-07-26 11:11:13.193191+03 | 2023-07-26 11:55:02.500033+03
        2023-07-26 11:11:13.193191+03 | 2023-07-26 11:26:03.176406+03
        2023-07-26 11:11:13.193191+03 | 2023-07-26 11:22:37.967449+03
        2023-07-26 11:11:13.193191+03 | 2023-07-26 12:09:41.149538+03
        2023-07-26 11:11:13.193191+03 | 2023-07-26 11:27:16.67582+03
        2023-07-26 11:11:13.193191+03 | 2023-07-26 11:50:15.106529+03
        2023-07-26 11:11:13.193191+03 | 2023-07-26 11:57:27.417962+03
       (10 rows)
       
       </pre></div>
       <p class="C">
       Вторую функцию (с параметром-интервалом) можно определить через первую:
       </p>
       <div class="S1">
       <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">rnd_timestamp</span><span style="color:#323232">(</span>t_start <span style="color:#a00050">timestamptz</span><span style="color:#323232">,</span> t_delta <span style="color:#a00050">interval</span><span style="color:#323232">)</span>
       <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">timestamptz</span>
       <span style="color:#3b6ac8">AS</span> $$
           <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">rnd_timestamp</span><span style="color:#323232">(</span>t_start<span style="color:#323232">,</span> t_start <span style="color:#323232">+</span> t_delta<span style="color:#323232">);</span>
       $$ <span style="color:#3b6ac8">VOLATILE LANGUAGE</span> sql<span style="color:#323232">;</span>
       </pre>
       </div>
       <div class="R1"><pre class="R1">CREATE FUNCTION
       </pre></div>
       <div class="S1">
       <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">rnd_timestamp</span><span style="color:#323232">(</span><span style="color:#c73a69">current_timestamp</span><span style="color:#323232">,</span> <span style="color:#a00050">interval</span> <span style="color:#1094a0">'1 hour'</span><span style="color:#323232">);</span>
       </pre>
       </div>
       <div class="R1"><pre class="R1">        rnd_timestamp         
       ------------------------------
        2023-07-26 12:08:08.34104+03
       (1 row)
       
       </pre></div>
       <h1>
       2. Автомобильные номера
       </h1>
       <p class="C">
       Создадим таблицу с номерами.
       </p>
       <div class="S1">
       <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE TABLE</span> <span style="color:#c73a69">cars</span><span style="color:#323232">(</span>
           id <span style="color:#a00050">integer</span> <span style="color:#3b6ac8">PRIMARY KEY GENERATED ALWAYS AS IDENTITY</span><span style="color:#323232">,</span>
           regnum <span style="color:#a00050">text</span>
       <span style="color:#323232">);</span>
       </pre>
       </div>
       <div class="R1"><pre class="R1">CREATE TABLE
       </pre></div>
       <div class="S1">
       <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">INSERT INTO</span> <span style="color:#c73a69">cars</span><span style="color:#323232">(</span>regnum<span style="color:#323232">)</span> <span style="color:#3b6ac8">VALUES</span>
           <span style="color:#323232">(</span><span style="color:#1094a0">'К 123 ХМ'</span><span style="color:#323232">), (</span><span style="color:#1094a0">'k123xm'</span><span style="color:#323232">), (</span><span style="color:#1094a0">'A 098BC'</span><span style="color:#323232">);</span>
       </pre>
       </div>
       <div class="R1"><pre class="R1">INSERT 0 3
       </pre></div>
       <p class="C">
       Функция нормализации:
       </p>
       <div class="S1">
       <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">normalize</span><span style="color:#323232">(</span>regnum <span style="color:#a00050">text</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">text</span>
       <span style="color:#3b6ac8">AS</span> $$
           <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">translate</span><span style="color:#323232">(</span><span style="color:#c73a69">upper</span><span style="color:#323232">(</span>regnum<span style="color:#323232">),</span> <span style="color:#1094a0">'АВЕКМНОРСТУХ '</span><span style="color:#323232">,</span> <span style="color:#1094a0">'ABEKMHOPCTYX'</span><span style="color:#323232">);</span>
       $$ <span style="color:#3b6ac8">IMMUTABLE LANGUAGE</span> sql<span style="color:#323232">;</span>
       </pre>
       </div>
       <div class="R1"><pre class="R1">CREATE FUNCTION
       </pre></div>
       <p class="C">
       Категория изменчивости — immutable. Функция всегда возвращает одинаковое значение при одних и тех же входных параметрах.
       </p>
       <div class="S1">
       <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">normalize</span><span style="color:#323232">(</span>regnum<span style="color:#323232">)</span> <span style="color:#3b6ac8">FROM</span> cars<span style="color:#323232">;</span>
       </pre>
       </div>
       <div class="R1"><pre class="R1"> normalize 
       -----------
        K123XM
        K123XM
        A098BC
       (3 rows)
       
       </pre></div>
       <p class="C">
       Теперь легко найти дубликаты:
       </p>
       <div class="S1">
       <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">num_unique</span><span style="color:#323232">()</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">bigint</span>
       <span style="color:#3b6ac8">AS</span> $$
           <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">count</span><span style="color:#323232">(</span><span style="color:#3b6ac8">DISTINCT</span> <span style="color:#c73a69">normalize</span><span style="color:#323232">(</span>regnum<span style="color:#323232">))</span>
           <span style="color:#3b6ac8">FROM</span> cars<span style="color:#323232">;</span>
       $$ <span style="color:#3b6ac8">STABLE LANGUAGE</span> sql<span style="color:#323232">;</span>
       </pre>
       </div>
       <div class="R1"><pre class="R1">CREATE FUNCTION
       </pre></div>
       <div class="S1">
       <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">num_unique</span><span style="color:#323232">();</span>
       </pre>
       </div>
       <div class="R1"><pre class="R1"> num_unique 
       ------------
                 2
       (1 row)
       
       </pre></div>
       <h1>
       3. Корни квадратного уравнения
       </h1>
       <div class="S1">
       <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">square_roots</span><span style="color:#323232">(</span>
           a <span style="color:#a00050">float</span><span style="color:#323232">,</span> 
           b <span style="color:#a00050">float</span><span style="color:#323232">,</span> 
           c <span style="color:#a00050">float</span><span style="color:#323232">,</span> 
           x1 <span style="color:#3b6ac8">OUT</span> <span style="color:#a00050">float</span><span style="color:#323232">,</span> 
           x2 <span style="color:#3b6ac8">OUT</span> <span style="color:#a00050">float</span>
       <span style="color:#323232">)</span>
       <span style="color:#3b6ac8">AS</span> $$
       <span style="color:#3b6ac8">WITH</span> <span style="color:#c73a69">discriminant</span><span style="color:#323232">(</span>d<span style="color:#323232">)</span> <span style="color:#3b6ac8">AS</span> <span style="color:#323232">(</span>
           <span style="color:#3b6ac8">SELECT</span> b<span style="color:#323232">*</span>b <span style="color:#323232">-</span> <span style="color:#1094a0">4</span><span style="color:#323232">*</span>a<span style="color:#323232">*</span>c
       <span style="color:#323232">)</span>
       <span style="color:#3b6ac8">SELECT CASE WHEN</span> d <span style="color:#323232">&gt;=</span> <span style="color:#1094a0">0.0</span> <span style="color:#3b6ac8">THEN</span> <span style="color:#323232">(-</span>b <span style="color:#323232">+</span> <span style="color:#c73a69">sqrt</span><span style="color:#323232">(</span>d<span style="color:#323232">))/</span><span style="color:#1094a0">2</span><span style="color:#323232">/</span>a <span style="color:#3b6ac8">END</span><span style="color:#323232">,</span>
              <span style="color:#3b6ac8">CASE WHEN</span> d <span style="color:#323232">&gt;</span>  <span style="color:#1094a0">0.0</span> <span style="color:#3b6ac8">THEN</span> <span style="color:#323232">(-</span>b <span style="color:#323232">-</span> <span style="color:#c73a69">sqrt</span><span style="color:#323232">(</span>d<span style="color:#323232">))/</span><span style="color:#1094a0">2</span><span style="color:#323232">/</span>a <span style="color:#3b6ac8">END</span>
       <span style="color:#3b6ac8">FROM</span> discriminant<span style="color:#323232">;</span>
       $$ <span style="color:#3b6ac8">IMMUTABLE LANGUAGE</span> sql<span style="color:#323232">;</span>
       </pre>
       </div>
       <div class="R1"><pre class="R1">CREATE FUNCTION
       </pre></div>
       <p class="C">
       Категория изменчивости — immutable. Функция всегда возвращает одинаковое значение при одних и тех же входных параметрах.
       </p>
       <div class="S1">
       <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">square_roots</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">,</span>  <span style="color:#1094a0">0</span><span style="color:#323232">, -</span><span style="color:#1094a0">4</span><span style="color:#323232">);</span>
       </pre>
       </div>
       <div class="R1"><pre class="R1"> square_roots 
       --------------
        (2,-2)
       (1 row)
       
       </pre></div>
       <div class="S1">
       <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">square_roots</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">, -</span><span style="color:#1094a0">4</span><span style="color:#323232">,</span>  <span style="color:#1094a0">4</span><span style="color:#323232">);</span>
       </pre>
       </div>
       <div class="R1"><pre class="R1"> square_roots 
       --------------
        (2,)
       (1 row)
       
       </pre></div>
       <div class="S1">
       <pre style="color:#323232; background-color:#ffffff;"><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">square_roots</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">,</span>  <span style="color:#1094a0">1</span><span style="color:#323232">,</span>  <span style="color:#1094a0">1</span><span style="color:#323232">);</span>
       </pre>
       </div>
       <div class="R1"><pre class="R1"> square_roots 
       --------------
        (,)
       (1 row)
       
       </pre></div>
       <!-- end -->
       
       
       </body></html>